#!/bin/bash
# SPDX-License-Identifier: Apache-2.0
# Copyright (c) 2024 Nelson Melo
#
# Update BlueField-3 security data for osquery ATC
# Run via cron to keep the osquery table current

set -euo pipefail

SCRIPT_DIR="$(dirname "$(readlink -f "$0")")"
CACHE_DIR="${BF3_CACHE_DIR:-/var/cache}"
JSON_FILE="${CACHE_DIR}/bf3_security.json"
DB_FILE="${CACHE_DIR}/bf3_security.db"

# Find the query script
if [[ -x "${SCRIPT_DIR}/bf3_security_query" ]]; then
    QUERY_SCRIPT="${SCRIPT_DIR}/bf3_security_query"
elif [[ -x "/usr/local/bin/bf3_security_query" ]]; then
    QUERY_SCRIPT="/usr/local/bin/bf3_security_query"
else
    echo "Error: bf3_security_query not found" >&2
    exit 1
fi

# Generate JSON
"${QUERY_SCRIPT}" > "${JSON_FILE}" 2>/dev/null

# Convert to SQLite for osquery ATC
python3 << PYSCRIPT
import json
import sqlite3
import sys

try:
    with open("${JSON_FILE}") as f:
        data = json.load(f)

    conn = sqlite3.connect("${DB_FILE}")
    c = conn.cursor()
    cols = list(data.keys())

    # Create table with proper schema
    c.execute("DROP TABLE IF EXISTS bf3_security")
    col_defs = ", ".join([f'"{col}" TEXT' for col in cols])
    c.execute(f"CREATE TABLE bf3_security ({col_defs})")

    # Insert data
    placeholders = ", ".join(["?" for _ in cols])
    values = [str(data.get(col, "")) for col in cols]
    c.execute(f"INSERT INTO bf3_security VALUES ({placeholders})", values)

    conn.commit()
    conn.close()
except Exception as e:
    print(f"Error updating database: {e}", file=sys.stderr)
    sys.exit(1)
PYSCRIPT
